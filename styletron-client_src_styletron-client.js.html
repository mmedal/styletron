<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>styletron-client/src/styletron-client.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>styletron-core</h3><ul><li><a href="StyletronCore.html">StyletronCore</a><ul class='methods'><li data-type='method'><a href="StyletronCore.html#injectDeclaration">injectDeclaration</a></li></ul></li></ul><h3>styletron-client</h3><ul><li><a href="StyletronClient.html">StyletronClient</a><ul class='methods'><li data-type='method'><a href="StyletronClient.html#injectDeclaration">injectDeclaration</a></li></ul></li></ul><h3>styletron-server</h3><ul><li><a href="StyletronServer.html">StyletronServer</a><ul class='methods'><li data-type='method'><a href="StyletronServer.html#getCss">getCss</a></li><li data-type='method'><a href="StyletronServer.html#injectDeclaration">injectDeclaration</a></li></ul></li></ul><h3>styletron-react</h3><ul><li><a href="StyletronProvider.html">StyletronProvider</a></li></ul><ul><li><a href="global.html#connectToStyles">connectToStyles</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">styletron-client/src/styletron-client.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fenwick = require('fenwick-tree');

const StyletronCore = require('styletron-core');

/**
 * StyletronClient
 * @extends StyletronCore
 * @packagename styletron-client
 * @example
 * const styleElement = document.querySelector('style');
 * const styletron = new StyletronClient(styleElement);
 */
class StyletronClient extends StyletronCore {
  /**
   * Create a new StyletronClient instance
   * @param {HTMLStyleElement} styleElement - Style element
   */
  constructor(styleElement) {
    super();
    if (!styleElement) {
      throw Error('no stylesheet');
    }
    const serverCount = styleElement.getAttribute('data-count');
    if (serverCount) {
      this.serverCount = parseInt(serverCount, 10);
      this.clientCount = 0;
    }
    this.counts = fenwick([0, 0]);
    this.styleElement = styleElement;
    this.hydrateCacheFromCssRules(styleElement.sheet.rules);
  }

  /*
   * Hydrate the cache from a CSSRuleList
   * @param {CSSRuleList} ruleList The rule list
   */
  hydrateCacheFromCssRules(ruleList) {
    let mediaCount = 0;
    let count = 0;
    for (let i = 0; i &lt; ruleList.length; i++) {
      const rule = ruleList[i];
      if (rule instanceof CSSStyleRule) {
        count++;
        assignRule(this.cache, cacheInfoFromCSSStyleRule(rule));
      } else if (rule instanceof CSSMediaRule) {
        const media = rule.media.mediaText;
        mediaCount++;
        for (let i = 0; i &lt; rule.cssRules.length; i++) {
          const info = cacheInfoFromCSSStyleRule(rule.cssRules[i]);
          info.media = media;
          assignRule(this.cache, info);
        }
      }
    }
    this.counts = fenwick([count, mediaCount]);
    this.counter = ruleList.length;
  }

  /**
   * Inject declaration into the stylesheet and return the unique class name
   * @return {string}      class name
   * @example
   * // &lt;style id="styletron">.c0{color:red}&lt;/style>
   * const styletron = new StyletronClient(document.getElementById('styletron'));
   * styletron.injectDeclaration({prop: 'color', val: 'blue'});
   * // → 'c1'
   * styletron.injectDeclaration({prop: 'color', val: 'red', media: '(min-width: 800px)'});
   * // → 'c2'
   * styletron.injectDeclaration({prop: 'color', val: 'red'});
   * // → 'c0'
   */
  injectDeclaration(decl) {
    const oldCount = this.counter;
    const className = super.injectDeclaration(decl);
    if (this.serverCount &amp;&amp; this.clientCount &lt; this.serverCount) {
      this.clientCount++;
      return className;
    }
    if (oldCount !== this.counter) {
      let index;
      if (!decl.media) {
        fenwick.update(this.counts, 0, 1);
        index = fenwick.query(this.counts, 0);
      } else {
        fenwick.update(this.counts, 1, 1);
        index = fenwick.query(this.counts, 1);
      }
      const rule = declarationToRule(className, decl);
      this.styleElement.sheet.insertRule(rule, index - 1);
    }
    return className;
  }

}

module.exports = StyletronClient;

/*
 * Hydration helpers
 */

function assignRule(target, ruleInfo) {
  let pseudo;
  let className;
  const index = ruleInfo.selector.indexOf(':');
  if (index !== -1) {
    pseudo = ruleInfo.selector.slice(index);
    className = getClassName(ruleInfo.selector.slice(0, index));
  } else {
    className = getClassName(ruleInfo.selector);
  }
  const decl = {
    prop: ruleInfo.prop,
    val: ruleInfo.val,
    media: ruleInfo.media,
    pseudo: pseudo
  };
  StyletronCore.assignDecl(target, decl, className);
}

function cacheInfoFromCSSStyleRule(rule) {
  let prop;
  let val;
  if (rule.style.length > 1) {
    const idx = rule.style.cssText.indexOf(': ');
    prop = rule.style.cssText.substring(0, idx);
    val = rule.style.cssText.substring(idx + 2, rule.style.cssText.length - 1);
  } else {
    prop = rule.style[0];
    val = rule.style[prop]
  }
  return {
    prop,
    val,
    selector: rule.selectorText
  };
}

function getClassName(classSelector) {
  return classSelector.substr(1);
}

/*
 * Injection helpers
 */

function declarationToRule(className, {prop, val, media, pseudo}) {
  const decl = `${prop}:${val}`;
  let selector = `.${className}`;
  if (pseudo) {
    selector += pseudo;
  }
  const rule = `${selector}{${decl}}`;
  return media ? `@media ${media}{${rule}}` : rule;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83207746-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
